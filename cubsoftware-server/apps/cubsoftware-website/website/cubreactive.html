<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#5865f2">
    <title>CubReactive - Discord Reactive Images | CUB SOFTWARE</title>
    <meta name="description" content="Create reactive Discord avatars for your stream. Upload custom images for speaking, idle, muted, and deafened states. Works with OBS browser source.">

    <link rel="icon" type="image/png" href="/static/images/company-logo.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/shared.css">
    <link rel="stylesheet" href="/static/css/cubreactive.css">
</head>
<body>
    <div class="main-container">
        {% include 'header.html' %}

        <main class="cubreactive-main">
            <div class="container">
                <!-- Hero Section -->
                <div class="cubreactive-hero">
                    <h1><span class="gradient-text">CubReactive</span></h1>
                    <p class="hero-subtitle">Discord Reactive Images for Streamers</p>
                    <p class="hero-description">Create custom reactive avatars that respond to your Discord voice activity. Perfect for PNGTubing and stream overlays.</p>
                </div>

                {% if not cubreactive_user %}
                <!-- Not Logged In -->
                <div class="login-section">
                    <div class="login-card">
                        <div class="login-icon">
                            <svg viewBox="0 0 24 24" fill="currentColor" width="48" height="48">
                                <path d="M19.27 5.33C17.94 4.71 16.5 4.26 15 4a.09.09 0 0 0-.07.03c-.18.33-.39.76-.53 1.09a16.09 16.09 0 0 0-4.8 0c-.14-.34-.35-.76-.54-1.09c-.01-.02-.04-.03-.07-.03c-1.5.26-2.93.71-4.27 1.33c-.01 0-.02.01-.03.02c-2.72 4.07-3.47 8.03-3.1 11.95c0 .02.01.04.03.05c1.8 1.32 3.53 2.12 5.24 2.65c.03.01.06 0 .07-.02c.4-.55.76-1.13 1.07-1.74c.02-.04 0-.08-.04-.09c-.57-.22-1.11-.48-1.64-.78c-.04-.02-.04-.08-.01-.11c.11-.08.22-.17.33-.25c.02-.02.05-.02.07-.01c3.44 1.57 7.15 1.57 10.55 0c.02-.01.05-.01.07.01c.11.09.22.17.33.26c.04.03.04.09-.01.11c-.52.31-1.07.56-1.64.78c-.04.01-.05.06-.04.09c.32.61.68 1.19 1.07 1.74c.03.01.06.02.09.01c1.72-.53 3.45-1.33 5.25-2.65c.02-.01.03-.03.03-.05c.44-4.53-.73-8.46-3.1-11.95c-.01-.01-.02-.02-.04-.02zM8.52 14.91c-1.03 0-1.89-.95-1.89-2.12s.84-2.12 1.89-2.12c1.06 0 1.9.96 1.89 2.12c0 1.17-.84 2.12-1.89 2.12zm6.97 0c-1.03 0-1.89-.95-1.89-2.12s.84-2.12 1.89-2.12c1.06 0 1.9.96 1.89 2.12c0 1.17-.83 2.12-1.89 2.12z"/>
                            </svg>
                        </div>
                        <h2>Login to Get Started</h2>
                        <p>Connect your Discord account to create your reactive avatar.</p>
                        <a href="/apps/cubreactive/auth/discord" class="discord-login-btn">
                            <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
                                <path d="M19.27 5.33C17.94 4.71 16.5 4.26 15 4a.09.09 0 0 0-.07.03c-.18.33-.39.76-.53 1.09a16.09 16.09 0 0 0-4.8 0c-.14-.34-.35-.76-.54-1.09c-.01-.02-.04-.03-.07-.03c-1.5.26-2.93.71-4.27 1.33c-.01 0-.02.01-.03.02c-2.72 4.07-3.47 8.03-3.1 11.95c0 .02.01.04.03.05c1.8 1.32 3.53 2.12 5.24 2.65c.03.01.06 0 .07-.02c.4-.55.76-1.13 1.07-1.74c.02-.04 0-.08-.04-.09c-.57-.22-1.11-.48-1.64-.78c-.04-.02-.04-.08-.01-.11c.11-.08.22-.17.33-.25c.02-.02.05-.02.07-.01c3.44 1.57 7.15 1.57 10.55 0c.02-.01.05-.01.07.01c.11.09.22.17.33.26c.04.03.04.09-.01.11c-.52.31-1.07.56-1.64.78c-.04.01-.05.06-.04.09c.32.61.68 1.19 1.07 1.74c.03.01.06.02.09.01c1.72-.53 3.45-1.33 5.25-2.65c.02-.01.03-.03.03-.05c.44-4.53-.73-8.46-3.1-11.95c-.01-.01-.02-.02-.04-.02zM8.52 14.91c-1.03 0-1.89-.95-1.89-2.12s.84-2.12 1.89-2.12c1.06 0 1.9.96 1.89 2.12c0 1.17-.84 2.12-1.89 2.12zm6.97 0c-1.03 0-1.89-.95-1.89-2.12s.84-2.12 1.89-2.12c1.06 0 1.9.96 1.89 2.12c0 1.17-.83 2.12-1.89 2.12z"/>
                            </svg>
                            Login with Discord
                        </a>
                    </div>

                    <!-- How It Works -->
                    <div class="how-it-works">
                        <h2>How It Works</h2>
                        <div class="steps-grid">
                            <div class="step">
                                <div class="step-number">1</div>
                                <h3>Login with Discord</h3>
                                <p>Connect your Discord account to get started.</p>
                            </div>
                            <div class="step">
                                <div class="step-number">2</div>
                                <h3>Upload Your Images</h3>
                                <p>Add images for speaking, idle, muted, and deafened states.</p>
                            </div>
                            <div class="step">
                                <div class="step-number">3</div>
                                <h3>Copy Browser Source</h3>
                                <p>Add the URL to OBS as a browser source.</p>
                            </div>
                            <div class="step">
                                <div class="step-number">4</div>
                                <h3>Go Live!</h3>
                                <p>Your avatar reacts in real-time to your voice.</p>
                            </div>
                        </div>
                    </div>
                </div>

                {% else %}
                <!-- Logged In Dashboard -->
                <div class="dashboard-section">
                    <!-- User Info -->
                    <div class="user-header">
                        <img src="{{ cubreactive_user.avatar }}" alt="Avatar" class="user-avatar-large">
                        <div class="user-info">
                            <h2>{{ cubreactive_user.username }}</h2>
                            <a href="/apps/cubreactive/auth/logout" class="logout-link">Logout</a>
                        </div>
                    </div>

                    <!-- Image Upload Section -->
                    <div class="upload-section">
                        <h2>Your Avatar Images</h2>
                        <p class="section-description">Upload images for each state. Supported formats: PNG, JPG, GIF, WebP (max 5MB each). Your Discord avatar is used as the default for any state without a custom image.</p>

                        <div class="images-grid">
                            <!-- Speaking -->
                            <div class="image-upload-card" data-state="speaking">
                                <div class="image-preview" id="preview-speaking">
                                    {% if user_config and user_config.images.speaking %}
                                    <img src="{{ user_config.images.speaking }}" alt="Speaking">
                                    {% else %}
                                    <img src="{{ cubreactive_user.avatar }}" alt="Speaking (Default)" class="default-avatar">
                                    {% endif %}
                                </div>
                                <div class="image-info">
                                    <span class="state-label speaking">Speaking</span>
                                    <p>Shown when you're talking</p>
                                    {% if not user_config or not user_config.images.speaking %}
                                    <span class="default-badge">Using Discord Avatar</span>
                                    {% endif %}
                                </div>
                                <div class="image-actions">
                                    <input type="file" id="upload-speaking" accept="image/*" hidden>
                                    <button class="btn-upload" onclick="document.getElementById('upload-speaking').click()">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                            <polyline points="17 8 12 3 7 8"/>
                                            <line x1="12" y1="3" x2="12" y2="15"/>
                                        </svg>
                                        Upload
                                    </button>
                                    <button class="btn-delete" onclick="deleteImage('speaking')" {% if not user_config or not user_config.images.speaking %}disabled{% endif %}>
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="3 6 5 6 21 6"/>
                                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>

                            <!-- Idle -->
                            <div class="image-upload-card" data-state="idle">
                                <div class="image-preview" id="preview-idle">
                                    {% if user_config and user_config.images.idle %}
                                    <img src="{{ user_config.images.idle }}" alt="Idle">
                                    {% else %}
                                    <img src="{{ cubreactive_user.avatar }}" alt="Idle (Default)" class="default-avatar">
                                    {% endif %}
                                </div>
                                <div class="image-info">
                                    <span class="state-label idle">Idle</span>
                                    <p>Shown when you're silent</p>
                                    {% if not user_config or not user_config.images.idle %}
                                    <span class="default-badge">Using Discord Avatar</span>
                                    {% endif %}
                                </div>
                                <div class="image-actions">
                                    <input type="file" id="upload-idle" accept="image/*" hidden>
                                    <button class="btn-upload" onclick="document.getElementById('upload-idle').click()">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                            <polyline points="17 8 12 3 7 8"/>
                                            <line x1="12" y1="3" x2="12" y2="15"/>
                                        </svg>
                                        Upload
                                    </button>
                                    <button class="btn-delete" onclick="deleteImage('idle')" {% if not user_config or not user_config.images.idle %}disabled{% endif %}>
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="3 6 5 6 21 6"/>
                                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>

                            <!-- Muted -->
                            <div class="image-upload-card" data-state="muted">
                                <div class="image-preview" id="preview-muted">
                                    {% if user_config and user_config.images.muted %}
                                    <img src="{{ user_config.images.muted }}" alt="Muted">
                                    {% else %}
                                    <img src="{{ cubreactive_user.avatar }}" alt="Muted (Default)" class="default-avatar">
                                    {% endif %}
                                </div>
                                <div class="image-info">
                                    <span class="state-label muted">Muted</span>
                                    <p>Shown when microphone is muted</p>
                                    {% if not user_config or not user_config.images.muted %}
                                    <span class="default-badge">Using Discord Avatar</span>
                                    {% endif %}
                                </div>
                                <div class="image-actions">
                                    <input type="file" id="upload-muted" accept="image/*" hidden>
                                    <button class="btn-upload" onclick="document.getElementById('upload-muted').click()">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                            <polyline points="17 8 12 3 7 8"/>
                                            <line x1="12" y1="3" x2="12" y2="15"/>
                                        </svg>
                                        Upload
                                    </button>
                                    <button class="btn-delete" onclick="deleteImage('muted')" {% if not user_config or not user_config.images.muted %}disabled{% endif %}>
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="3 6 5 6 21 6"/>
                                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>

                            <!-- Deafened -->
                            <div class="image-upload-card" data-state="deafened">
                                <div class="image-preview" id="preview-deafened">
                                    {% if user_config and user_config.images.deafened %}
                                    <img src="{{ user_config.images.deafened }}" alt="Deafened">
                                    {% else %}
                                    <img src="{{ cubreactive_user.avatar }}" alt="Deafened (Default)" class="default-avatar">
                                    {% endif %}
                                </div>
                                <div class="image-info">
                                    <span class="state-label deafened">Deafened</span>
                                    <p>Shown when audio is deafened</p>
                                    {% if not user_config or not user_config.images.deafened %}
                                    <span class="default-badge">Using Discord Avatar</span>
                                    {% endif %}
                                </div>
                                <div class="image-actions">
                                    <input type="file" id="upload-deafened" accept="image/*" hidden>
                                    <button class="btn-upload" onclick="document.getElementById('upload-deafened').click()">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                            <polyline points="17 8 12 3 7 8"/>
                                            <line x1="12" y1="3" x2="12" y2="15"/>
                                        </svg>
                                        Upload
                                    </button>
                                    <button class="btn-delete" onclick="deleteImage('deafened')" {% if not user_config or not user_config.images.deafened %}disabled{% endif %}>
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="3 6 5 6 21 6"/>
                                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Settings Section -->
                    <div class="settings-section">
                        <h2>Overlay Settings</h2>

                        <!-- Basic Settings -->
                        <div class="settings-group">
                            <h3>Basic Options</h3>
                            <div class="settings-grid">
                                <label class="setting-toggle">
                                    <input type="checkbox" id="setting-bounce" {% if user_config and user_config.settings.bounce_on_speak %}checked{% endif %}>
                                    <span class="toggle-slider"></span>
                                    <span class="setting-label">Bounce when speaking</span>
                                </label>
                                <label class="setting-toggle">
                                    <input type="checkbox" id="setting-dim" {% if user_config and user_config.settings.dim_when_idle %}checked{% endif %}>
                                    <span class="toggle-slider"></span>
                                    <span class="setting-label">Dim when idle</span>
                                </label>
                                <label class="setting-toggle">
                                    <input type="checkbox" id="setting-name" {% if user_config and user_config.settings.show_name %}checked{% endif %}>
                                    <span class="toggle-slider"></span>
                                    <span class="setting-label">Show username</span>
                                </label>
                                <label class="setting-toggle">
                                    <input type="checkbox" id="setting-grayscale-muted" {% if not user_config or user_config.settings.grayscale_muted != false %}checked{% endif %}>
                                    <span class="toggle-slider"></span>
                                    <span class="setting-label">Grayscale when muted</span>
                                </label>
                                <label class="setting-toggle">
                                    <input type="checkbox" id="setting-grayscale-deafened" {% if not user_config or user_config.settings.grayscale_deafened != false %}checked{% endif %}>
                                    <span class="toggle-slider"></span>
                                    <span class="setting-label">Grayscale when deafened</span>
                                </label>
                            </div>
                        </div>

                        <!-- Animation Style -->
                        <div class="settings-group">
                            <h3>Animation Style</h3>
                            <p class="setting-description">Choose how your avatar animates when speaking</p>
                            <div class="style-buttons">
                                <button type="button" class="style-btn {% if not user_config or not user_config.settings.animation_style or user_config.settings.animation_style == 'bounce' %}active{% endif %}" data-style="bounce">Bounce</button>
                                <button type="button" class="style-btn {% if user_config and user_config.settings.animation_style == 'pulse' %}active{% endif %}" data-style="pulse">Pulse</button>
                                <button type="button" class="style-btn {% if user_config and user_config.settings.animation_style == 'glow' %}active{% endif %}" data-style="glow">Glow</button>
                                <button type="button" class="style-btn {% if user_config and user_config.settings.animation_style == 'shake' %}active{% endif %}" data-style="shake">Shake</button>
                                <button type="button" class="style-btn {% if user_config and user_config.settings.animation_style == 'wave' %}active{% endif %}" data-style="wave">Wave</button>
                                <button type="button" class="style-btn {% if user_config and user_config.settings.animation_style == 'none' %}active{% endif %}" data-style="none">None</button>
                            </div>
                            <input type="hidden" id="setting-animation" value="{{ user_config.settings.animation_style if user_config and user_config.settings.animation_style else 'bounce' }}">
                        </div>

                        <!-- Avatar Shape -->
                        <div class="settings-group">
                            <h3>Avatar Shape</h3>
                            <div class="shape-buttons">
                                <button type="button" class="shape-btn {% if not user_config or not user_config.settings.avatar_shape or user_config.settings.avatar_shape == 'rounded' %}active{% endif %}" data-shape="rounded">
                                    <div class="shape-preview rounded"></div>
                                    <span>Rounded</span>
                                </button>
                                <button type="button" class="shape-btn {% if user_config and user_config.settings.avatar_shape == 'circle' %}active{% endif %}" data-shape="circle">
                                    <div class="shape-preview circle"></div>
                                    <span>Circle</span>
                                </button>
                                <button type="button" class="shape-btn {% if user_config and user_config.settings.avatar_shape == 'square' %}active{% endif %}" data-shape="square">
                                    <div class="shape-preview square"></div>
                                    <span>Square</span>
                                </button>
                                <button type="button" class="shape-btn {% if user_config and user_config.settings.avatar_shape == 'hexagon' %}active{% endif %}" data-shape="hexagon">
                                    <div class="shape-preview hexagon"></div>
                                    <span>Hexagon</span>
                                </button>
                            </div>
                            <input type="hidden" id="setting-shape" value="{{ user_config.settings.avatar_shape if user_config and user_config.settings.avatar_shape else 'rounded' }}">
                        </div>

                        <!-- Avatar Size -->
                        <div class="settings-group">
                            <h3>Avatar Size</h3>
                            <div class="slider-setting">
                                <input type="range" id="setting-size" min="80" max="300" value="{{ user_config.settings.avatar_size if user_config and user_config.settings.avatar_size else 180 }}">
                                <span class="slider-value" id="size-value">{{ user_config.settings.avatar_size if user_config and user_config.settings.avatar_size else 180 }}px</span>
                            </div>
                        </div>

                        <!-- Border Settings -->
                        <div class="settings-group">
                            <h3>Border</h3>
                            <label class="setting-toggle">
                                <input type="checkbox" id="setting-border" {% if user_config and user_config.settings.border_enabled %}checked{% endif %}>
                                <span class="toggle-slider"></span>
                                <span class="setting-label">Enable border</span>
                            </label>
                            <div class="border-options" id="border-options" style="{% if not user_config or not user_config.settings.border_enabled %}display:none{% endif %}">
                                <div class="color-setting">
                                    <label>Border Color</label>
                                    <input type="color" id="setting-border-color" value="{{ user_config.settings.border_color if user_config and user_config.settings.border_color else '#5865f2' }}">
                                </div>
                                <div class="slider-setting">
                                    <label>Border Width</label>
                                    <input type="range" id="setting-border-width" min="1" max="10" value="{{ user_config.settings.border_width if user_config and user_config.settings.border_width else 3 }}">
                                    <span class="slider-value" id="border-width-value">{{ user_config.settings.border_width if user_config and user_config.settings.border_width else 3 }}px</span>
                                </div>
                            </div>
                        </div>

                        <!-- Glow Settings -->
                        <div class="settings-group">
                            <h3>Glow Effect</h3>
                            <label class="setting-toggle">
                                <input type="checkbox" id="setting-glow" {% if user_config and user_config.settings.glow_enabled %}checked{% endif %}>
                                <span class="toggle-slider"></span>
                                <span class="setting-label">Enable glow when speaking</span>
                            </label>
                            <div class="glow-options" id="glow-options" style="{% if not user_config or not user_config.settings.glow_enabled %}display:none{% endif %}">
                                <div class="color-setting">
                                    <label>Glow Color</label>
                                    <input type="color" id="setting-glow-color" value="{{ user_config.settings.glow_color if user_config and user_config.settings.glow_color else '#5865f2' }}">
                                </div>
                            </div>
                        </div>

                        <!-- Name Settings -->
                        <div class="settings-group">
                            <h3>Username Style</h3>
                            <div class="name-options">
                                <div class="color-setting">
                                    <label>Name Color</label>
                                    <input type="color" id="setting-name-color" value="{{ user_config.settings.name_color if user_config and user_config.settings.name_color else '#ffffff' }}">
                                </div>
                                <div class="slider-setting">
                                    <label>Name Size</label>
                                    <input type="range" id="setting-name-size" min="10" max="24" value="{{ user_config.settings.name_size if user_config and user_config.settings.name_size else 14 }}">
                                    <span class="slider-value" id="name-size-value">{{ user_config.settings.name_size if user_config and user_config.settings.name_size else 14 }}px</span>
                                </div>
                            </div>
                        </div>

                        <!-- Overlay Position -->
                        <div class="settings-group">
                            <h3>Overlay Position (Group Mode)</h3>
                            <p class="setting-description">Choose where avatars appear in the group overlay</p>
                            <div class="position-buttons">
                                <button type="button" class="position-btn {% if not user_config or not user_config.settings.overlay_position or user_config.settings.overlay_position == 'top' %}active{% endif %}" data-position="top">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="2" y="2" width="20" height="6" rx="1"/>
                                        <rect x="2" y="10" width="20" height="12" rx="1" opacity="0.3"/>
                                    </svg>
                                    <span>Top</span>
                                </button>
                                <button type="button" class="position-btn {% if user_config and user_config.settings.overlay_position == 'bottom' %}active{% endif %}" data-position="bottom">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="2" y="2" width="20" height="12" rx="1" opacity="0.3"/>
                                        <rect x="2" y="16" width="20" height="6" rx="1"/>
                                    </svg>
                                    <span>Bottom</span>
                                </button>
                                <button type="button" class="position-btn {% if user_config and user_config.settings.overlay_position == 'left' %}active{% endif %}" data-position="left">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="2" y="2" width="6" height="20" rx="1"/>
                                        <rect x="10" y="2" width="12" height="20" rx="1" opacity="0.3"/>
                                    </svg>
                                    <span>Left</span>
                                </button>
                                <button type="button" class="position-btn {% if user_config and user_config.settings.overlay_position == 'right' %}active{% endif %}" data-position="right">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="2" y="2" width="12" height="20" rx="1" opacity="0.3"/>
                                        <rect x="16" y="2" width="6" height="20" rx="1"/>
                                    </svg>
                                    <span>Right</span>
                                </button>
                            </div>
                            <input type="hidden" id="setting-position" value="{{ user_config.settings.overlay_position if user_config and user_config.settings.overlay_position else 'bottom' }}">
                        </div>

                        <!-- Spacing -->
                        <div class="settings-group">
                            <h3>Spacing Between Avatars</h3>
                            <div class="slider-setting">
                                <input type="range" id="setting-spacing" min="5" max="50" value="{{ user_config.settings.spacing if user_config and user_config.settings.spacing else 20 }}">
                                <span class="slider-value" id="spacing-value">{{ user_config.settings.spacing if user_config and user_config.settings.spacing else 20 }}px</span>
                            </div>
                        </div>

                        <!-- Speaking Ring -->
                        <div class="settings-group">
                            <h3>Speaking Indicator Ring</h3>
                            <label class="setting-toggle">
                                <input type="checkbox" id="setting-speaking-ring" {% if not user_config or user_config.settings.speaking_ring_enabled != false %}checked{% endif %}>
                                <span class="toggle-slider"></span>
                                <span class="setting-label">Show ring when speaking</span>
                            </label>
                            <div class="speaking-ring-options" id="speaking-ring-options" style="{% if user_config and user_config.settings.speaking_ring_enabled == false %}display:none{% endif %}">
                                <div class="color-setting">
                                    <label>Ring Color</label>
                                    <input type="color" id="setting-speaking-ring-color" value="{{ user_config.settings.speaking_ring_color if user_config and user_config.settings.speaking_ring_color else '#57f287' }}">
                                </div>
                                <div class="slider-setting">
                                    <label>Ring Width</label>
                                    <input type="range" id="setting-speaking-ring-width" min="2" max="8" value="{{ user_config.settings.speaking_ring_width if user_config and user_config.settings.speaking_ring_width else 4 }}">
                                    <span class="slider-value" id="speaking-ring-width-value">{{ user_config.settings.speaking_ring_width if user_config and user_config.settings.speaking_ring_width else 4 }}px</span>
                                </div>
                            </div>
                        </div>

                        <!-- Shadow Settings -->
                        <div class="settings-group">
                            <h3>Shadow Effect</h3>
                            <label class="setting-toggle">
                                <input type="checkbox" id="setting-shadow" {% if user_config and user_config.settings.shadow_enabled %}checked{% endif %}>
                                <span class="toggle-slider"></span>
                                <span class="setting-label">Enable drop shadow</span>
                            </label>
                            <div class="shadow-options" id="shadow-options" style="{% if not user_config or not user_config.settings.shadow_enabled %}display:none{% endif %}">
                                <div class="color-setting">
                                    <label>Shadow Color</label>
                                    <input type="color" id="setting-shadow-color" value="{{ user_config.settings.shadow_color if user_config and user_config.settings.shadow_color else '#000000' }}">
                                </div>
                                <div class="slider-setting">
                                    <label>Shadow Blur</label>
                                    <input type="range" id="setting-shadow-blur" min="5" max="30" value="{{ user_config.settings.shadow_blur if user_config and user_config.settings.shadow_blur else 10 }}">
                                    <span class="slider-value" id="shadow-blur-value">{{ user_config.settings.shadow_blur if user_config and user_config.settings.shadow_blur else 10 }}px</span>
                                </div>
                            </div>
                        </div>

                        <!-- Transition Settings -->
                        <div class="settings-group">
                            <h3>State Transitions</h3>
                            <p class="setting-description">How avatars transition between states</p>
                            <div class="style-buttons">
                                <button type="button" class="style-btn {% if not user_config or not user_config.settings.transition_style or user_config.settings.transition_style == 'fade' %}active{% endif %}" data-transition="fade">Fade</button>
                                <button type="button" class="style-btn {% if user_config and user_config.settings.transition_style == 'slide' %}active{% endif %}" data-transition="slide">Slide</button>
                                <button type="button" class="style-btn {% if user_config and user_config.settings.transition_style == 'zoom' %}active{% endif %}" data-transition="zoom">Zoom</button>
                                <button type="button" class="style-btn {% if user_config and user_config.settings.transition_style == 'flip' %}active{% endif %}" data-transition="flip">Flip</button>
                                <button type="button" class="style-btn {% if user_config and user_config.settings.transition_style == 'none' %}active{% endif %}" data-transition="none">None</button>
                            </div>
                            <input type="hidden" id="setting-transition" value="{{ user_config.settings.transition_style if user_config and user_config.settings.transition_style else 'fade' }}">
                            <div class="slider-setting" style="margin-top: 1rem;">
                                <label>Duration</label>
                                <input type="range" id="setting-transition-duration" min="100" max="500" step="50" value="{{ user_config.settings.transition_duration if user_config and user_config.settings.transition_duration else 200 }}">
                                <span class="slider-value" id="transition-duration-value">{{ user_config.settings.transition_duration if user_config and user_config.settings.transition_duration else 200 }}ms</span>
                            </div>
                        </div>

                        <!-- Status Icons -->
                        <div class="settings-group">
                            <h3>Status Icons</h3>
                            <label class="setting-toggle">
                                <input type="checkbox" id="setting-status-icons" {% if not user_config or user_config.settings.show_status_icons != false %}checked{% endif %}>
                                <span class="toggle-slider"></span>
                                <span class="setting-label">Show muted/deafened icons</span>
                            </label>
                        </div>

                        <!-- Name Background -->
                        <div class="settings-group">
                            <h3>Username Background</h3>
                            <label class="setting-toggle">
                                <input type="checkbox" id="setting-name-bg" {% if user_config and user_config.settings.name_background_enabled %}checked{% endif %}>
                                <span class="toggle-slider"></span>
                                <span class="setting-label">Enable background behind name</span>
                            </label>
                            <div class="name-bg-options" id="name-bg-options" style="{% if not user_config or not user_config.settings.name_background_enabled %}display:none{% endif %}">
                                <div class="color-setting">
                                    <label>Background Color</label>
                                    <input type="color" id="setting-name-bg-color" value="{{ user_config.settings.name_background_color[:7] if user_config and user_config.settings.name_background_color else '#000000' }}">
                                </div>
                            </div>
                        </div>

                        <!-- Overlay Background -->
                        <div class="settings-group">
                            <h3>Overlay Background</h3>
                            <p class="setting-description">Set a background color for the entire overlay (useful for testing)</p>
                            <div class="color-setting">
                                <label>Background</label>
                                <input type="color" id="setting-overlay-bg" value="{{ user_config.settings.overlay_background if user_config and user_config.settings.overlay_background and user_config.settings.overlay_background != 'transparent' else '#000000' }}">
                                <label class="setting-toggle" style="margin-left: 1rem;">
                                    <input type="checkbox" id="setting-overlay-bg-transparent" {% if not user_config or not user_config.settings.overlay_background or user_config.settings.overlay_background == 'transparent' %}checked{% endif %}>
                                    <span class="toggle-slider"></span>
                                    <span class="setting-label">Transparent</span>
                                </label>
                            </div>
                        </div>

                        <!-- Idle Opacity -->
                        <div class="settings-group">
                            <h3>Idle Opacity</h3>
                            <p class="setting-description">Avatar opacity when not speaking (100% = fully visible)</p>
                            <div class="slider-setting">
                                <input type="range" id="setting-idle-opacity" min="20" max="100" value="{{ user_config.settings.idle_opacity if user_config and user_config.settings.idle_opacity else 100 }}">
                                <span class="slider-value" id="idle-opacity-value">{{ user_config.settings.idle_opacity if user_config and user_config.settings.idle_opacity else 100 }}%</span>
                            </div>
                        </div>

                        <!-- Additional Options -->
                        <div class="settings-group">
                            <h3>Additional Options</h3>
                            <div class="settings-grid">
                                <label class="setting-toggle">
                                    <input type="checkbox" id="setting-flip" {% if user_config and user_config.settings.flip_horizontal %}checked{% endif %}>
                                    <span class="toggle-slider"></span>
                                    <span class="setting-label">Flip avatar horizontally</span>
                                </label>
                                <label class="setting-toggle">
                                    <input type="checkbox" id="setting-hide-self" {% if user_config and user_config.settings.hide_self %}checked{% endif %}>
                                    <span class="toggle-slider"></span>
                                    <span class="setting-label">Hide self in group view</span>
                                </label>
                            </div>
                            <div class="slider-setting" style="margin-top: 1rem;">
                                <label>Max Participants (0 = unlimited)</label>
                                <input type="range" id="setting-max-participants" min="0" max="10" value="{{ user_config.settings.max_participants if user_config and user_config.settings.max_participants else 0 }}">
                                <span class="slider-value" id="max-participants-value">{{ user_config.settings.max_participants if user_config and user_config.settings.max_participants else 0 }}</span>
                            </div>
                        </div>

                        <!-- Preset Themes -->
                        <div class="settings-group">
                            <h3>Quick Themes</h3>
                            <p class="setting-description">Apply a preset theme (will override current settings)</p>
                            <div class="theme-buttons">
                                <button type="button" class="theme-btn" data-theme="default" onclick="applyTheme('default')">
                                    <div class="theme-preview default"></div>
                                    <span>Default</span>
                                </button>
                                <button type="button" class="theme-btn" data-theme="discord" onclick="applyTheme('discord')">
                                    <div class="theme-preview discord"></div>
                                    <span>Discord</span>
                                </button>
                                <button type="button" class="theme-btn" data-theme="neon" onclick="applyTheme('neon')">
                                    <div class="theme-preview neon"></div>
                                    <span>Neon</span>
                                </button>
                                <button type="button" class="theme-btn" data-theme="minimal" onclick="applyTheme('minimal')">
                                    <div class="theme-preview minimal"></div>
                                    <span>Minimal</span>
                                </button>
                                <button type="button" class="theme-btn" data-theme="retro" onclick="applyTheme('retro')">
                                    <div class="theme-preview retro"></div>
                                    <span>Retro</span>
                                </button>
                            </div>
                        </div>

                        <button class="btn-save-settings" onclick="saveSettings()">Save Settings</button>
                    </div>

                    <!-- Browser Source URLs -->
                    <div class="sources-section">
                        <h2>Browser Source URLs</h2>
                        <p class="section-description">Copy these URLs and add them as browser sources in OBS. Make sure Discord desktop app is running.</p>

                        <div class="source-card">
                            <div class="source-header">
                                <h3>Individual Source</h3>
                                <span class="source-badge">Your Avatar Only</span>
                            </div>
                            <p>Shows only your avatar. Use this for a single-person overlay.</p>
                            <div class="source-url-container">
                                <input type="text" readonly value="{{ request.host_url }}apps/cubreactive/overlay/{{ cubreactive_user.id }}" id="individual-url">
                                <button class="btn-copy" onclick="copyUrl('individual-url')">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                                    </svg>
                                    Copy
                                </button>
                            </div>
                            <p class="source-hint">Recommended size: 300x300</p>
                        </div>

                        <div class="source-card">
                            <div class="source-header">
                                <h3>Group Source</h3>
                                <span class="source-badge secondary">All Participants</span>
                            </div>
                            <p>Shows all participants in your voice channel. Perfect for collabs.</p>
                            <div class="source-url-container">
                                <input type="text" readonly value="{{ request.host_url }}apps/cubreactive/overlay/group" id="group-url">
                                <button class="btn-copy" onclick="copyUrl('group-url')">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                                    </svg>
                                    Copy
                                </button>
                            </div>
                            <p class="source-hint">Recommended size: 800x200 (horizontal) or 200x800 (vertical)</p>
                        </div>
                    </div>

                    <!-- Preview Section -->
                    <div class="preview-section">
                        <h2>Preview</h2>
                        <p class="section-description">See how your avatar will look. Click to simulate speaking.</p>
                        <div class="preview-container" id="preview-container">
                            <div class="preview-avatar" id="preview-avatar" onclick="togglePreviewSpeaking()">
                                {% if user_config and user_config.images.idle %}
                                <img src="{{ user_config.images.idle }}" alt="Preview" id="preview-image">
                                {% elif user_config and user_config.images.speaking %}
                                <img src="{{ user_config.images.speaking }}" alt="Preview" id="preview-image">
                                {% else %}
                                <img src="{{ cubreactive_user.avatar }}" alt="Preview" id="preview-image">
                                {% endif %}
                                {% if user_config and user_config.settings.show_name %}
                                <span class="preview-name">{{ cubreactive_user.username }}</span>
                                {% endif %}
                            </div>
                        </div>
                        <p class="preview-hint">Click avatar to toggle speaking state</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </main>

        {% include 'footer.html' %}
    </div>

    <div id="toast" class="toast"></div>

    <script>
        const USER_ID = "{{ cubreactive_user.id if cubreactive_user else '' }}";
        const USER_AVATAR = "{{ cubreactive_user.avatar if cubreactive_user else '' }}";
        const USER_CONFIG = {{ user_config | tojson if user_config else '{}' | safe }};
    </script>
    <script src="/static/js/cubreactive.js"></script>
</body>
</html>

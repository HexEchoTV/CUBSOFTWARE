# CubSoftware Server - Nginx Configuration
# Place this file in /etc/nginx/sites-available/cubsoftware
# Then symlink: sudo ln -s /etc/nginx/sites-available/cubsoftware /etc/nginx/sites-enabled/
# Test config: sudo nginx -t
# Reload: sudo systemctl reload nginx

# ============================================
# Upstream Servers (Backend Services)
# ============================================
upstream cubsoftware_website {
    server 127.0.0.1:3000;
    keepalive 32;
}

upstream cubvault_api {
    server 127.0.0.1:3001;
    keepalive 32;
}

upstream cubvault_web {
    server 127.0.0.1:3002;
    keepalive 32;
}

upstream questcord_web {
    server 127.0.0.1:3003;
    keepalive 32;
}

# ============================================
# Short Link Domain: cubsw.link
# ============================================
server {
    listen 80;
    listen [::]:80;
    server_name cubsw.link www.cubsw.link;

    # Cloudflare handles SSL, so we just proxy HTTP
    location / {
        proxy_pass http://cubsoftware_website;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}

# ============================================
# Main Site: cubsoftware.site
# ============================================
server {
    listen 80;
    listen [::]:80;
    server_name cubsoftware.site www.cubsoftware.site;

    # Redirect to HTTPS (uncomment when SSL is configured)
    # return 301 https://$server_name$request_uri;

    # For HTTP (before SSL is set up)
    location / {
        proxy_pass http://cubsoftware_website;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
    }

    # Redirect /questcord to questcord.fun
    location /questcord {
        return 301 https://questcord.fun$is_args$args;
    }

    location /questcord/ {
        return 301 https://questcord.fun$is_args$args;
    }

    # Static files caching
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|woff|woff2|ttf|svg)$ {
        proxy_pass http://cubsoftware_website;
        proxy_set_header Host $host;
        expires 7d;
        add_header Cache-Control "public, immutable";
    }
}

# HTTPS version of cubsoftware.site (uncomment when SSL is configured)
# server {
#     listen 443 ssl http2;
#     listen [::]:443 ssl http2;
#     server_name cubsoftware.site www.cubsoftware.site;
#
#     ssl_certificate /etc/letsencrypt/live/cubsoftware.site/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/cubsoftware.site/privkey.pem;
#     include /etc/letsencrypt/options-ssl-nginx.conf;
#     ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
#
#     location / {
#         proxy_pass http://cubsoftware_website;
#         proxy_http_version 1.1;
#         proxy_set_header Upgrade $http_upgrade;
#         proxy_set_header Connection 'upgrade';
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#         proxy_cache_bypass $http_upgrade;
#         proxy_read_timeout 300s;
#     }
#
#     location /questcord {
#         return 301 https://questcord.fun$is_args$args;
#     }
# }

# ============================================
# QuestCord: questcord.fun
# ============================================
server {
    listen 80;
    listen [::]:80;
    server_name questcord.fun www.questcord.fun;

    # Redirect to HTTPS (uncomment when SSL is configured)
    # return 301 https://$server_name$request_uri;

    location / {
        proxy_pass http://questcord_web;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 86400s;  # Long timeout for WebSocket
        proxy_send_timeout 86400s;
    }

    # WebSocket support for real-time features
    location /ws {
        proxy_pass http://questcord_web;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;
    }

    # Static files
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|woff|woff2|ttf|svg)$ {
        proxy_pass http://questcord_web;
        proxy_set_header Host $host;
        expires 7d;
        add_header Cache-Control "public, immutable";
    }
}

# ============================================
# QuestCord Subdomain: questcord.cubsoftware.site
# Redirects to questcord.fun
# ============================================
server {
    listen 80;
    listen [::]:80;
    server_name questcord.cubsoftware.site;

    # Permanent redirect to questcord.fun
    return 301 https://questcord.fun$request_uri;
}

# ============================================
# CubVault: cubvault.cubsoftware.site
# ============================================
server {
    listen 80;
    listen [::]:80;
    server_name cubvault.cubsoftware.site;

    # Redirect to HTTPS (uncomment when SSL is configured)
    # return 301 https://$server_name$request_uri;

    # Frontend (Web App)
    location / {
        proxy_pass http://cubvault_web;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # API routes
    location /api {
        proxy_pass http://cubvault_api;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 60s;
    }

    # Static files caching
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|woff|woff2|ttf|svg)$ {
        proxy_pass http://cubvault_web;
        proxy_set_header Host $host;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
}

# ============================================
# Tools: tools.cubsoftware.site
# Redirects to cubsoftware.site/apps (Social Media Saver, etc.)
# ============================================
server {
    listen 80;
    listen [::]:80;
    server_name tools.cubsoftware.site;

    # Redirect to the apps section of main site
    location / {
        return 301 https://cubsoftware.site/apps$request_uri;
    }
}

# ============================================
# StreamerBot: streamerbot.cubsoftware.site
# Serves the StreamerBot Commands documentation website
# ============================================
server {
    listen 80;
    listen [::]:80;
    server_name streamerbot.cubsoftware.site;

    # Serve static documentation
    root /var/www/cubsoftware/streamerbot-docs;
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;
    }

    # Static files caching
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|woff|woff2|ttf|svg)$ {
        expires 7d;
        add_header Cache-Control "public, immutable";
    }
}

# ============================================
# Catch-all for other subdomains
# ============================================
server {
    listen 80 default_server;
    listen [::]:80 default_server;
    server_name *.cubsoftware.site;

    # Redirect unknown subdomains to main site
    return 301 https://cubsoftware.site$request_uri;
}
